# توثيق مكونات المحرر (Editor Components Documentation)

## نظرة عامة
هذا الملف يوثق جميع مكونات محرر السيناريو في مشروع Filmlane. المكونات مسؤولة عن إنشاء واجهة مستخدم متكاملة لكتابة وتنسيق السيناريوهات بشكل احترافي.

---

## هيكل المجلد
```
src/components/editor/
├── EditorArea.tsx       # منطقة الكتابة الرئيسية
├── EditorFooter.tsx     # الشريط السفلي للمحرر
├── EditorHeader.tsx     # الشريط العلوي للمحرر
├── EditorSidebar.tsx    # الشريط الجانبي للمحرر
├── EditorToolbar.tsx    # شريط الأدوات
├── ScreenplayEditor.tsx # المكون الرئيسي للمحرر
└── index.ts             # ملف تصدير المكونات
```

---

## 1. EditorArea.tsx
**المسار:** [src/components/editor/EditorArea.tsx](src/components/editor/EditorArea.tsx)

**الدور:** منطقة الكتابة الرئيسية القابلة للتعديل (contentEditable) التي تتعامل مع إدخال النص وتنسيقه.

### الواجهة (Interface)
```typescript
interface EditorAreaProps {
    onContentChange: () => void;    // يتم استدعاؤه عند تغيير المحتوى
    onStatsChange: (stats: DocumentStats) => void;  // تحديث إحصائيات المستند
    onFormatChange: (format: string) => void;       // تحديث نوع التنسيق الحالي
    font: string;                  // نوع الخط المستخدم
    size: string;                  // حجم الخط
}
```

### الدوال (Functions)

#### 1. `updateStats()`
- **السطر:** 18-26
- **الدور:** تحديث إحصائيات المستند (عدد الكلمات، الأحرف، الصفحات، المشاهد)
- **تفصيل سطر بسطر:**
  - 19: التحقق من وجود مرجع صالح للمحرر
  - 20: استخراج النص من المحرر
  - 21: حساب عدد الكلمات بتقسيم النص على المسافات
  - 22: حساب عدد الأحرف
  - 23: حساب عدد المشاهد (عناصر scene-header-1)
  - 24: حساب عدد الصفحات بناءً على ارتفاع المحتوى
  - 25: استدعاء دالة التحديث بالإحصائيات المحسوبة

#### 2. `isCurrentElementEmpty()`
- **السطر:** 28-41
- **الدور:** التحقق مما إذا كان العنصر الحالي فارغاً
- **تفصيل:**
  - 29-30: الحصول على تحديد النص الحالي
  - 31-38: البحث عن العنصر الأصلي القابل للتعديل
  - 39-40: التحقق من فراغ محتوى العنصر

#### 3. `getCurrentFormat()`
- **السطر:** 43-58
- **الدور:** الحصول على نوع التنسيق الحالي للعنصر المحدد
- **تفصيل:**
  - 44-45: الحصول على تحديد النص الحالي
  - 46-52: البحث عن العنصر الأصلي contentEditable
  - 53-57: البحث عن التنسيق في قائمة التنسيقات المعروفة

#### 4. `applyFormatToCurrentLine(formatType: string)`
- **السطر:** 60-92
- **الدور:** تطبيق تنسيق محدد على السطر الحالي
- **تفصيل:**
  - 61-69: الحصول على العنصر الحالي المحدد
  - 71-79: إنشاء عنصر DIV جديد إذا لم يكن موجوداً
  - 82: حذف جميع فئات التنسيق السابقة
  - 83: إضافة فئة التنسيق الجديد
  - 85-89: وضع المؤشر في نهاية العنصر
  - 90: إخطار بتغيير المحتوى

#### 5. `getNextFormatOnTab(currentFormat: string, isEmpty: boolean, shiftPressed: boolean)`
- **السطر:** 94-106
- **الدور:** تحديد التنسيق التالي عند الضغط على Tab
- **تفصيل:**
  - 95: تعريف التسلسل الرئيسي للتنسيقات
  - 96: الانتقال إلى transition أو action عند character
  - 97: الانتقال بين dialogue و parenthetical
  - 98: البقاء في dialogue من parenthetical
  - 100-104: التنقل في التسلسل الرئيسي بالاتجاهين

#### 6. `handleInteraction()`
- **السطر:** 108-124
- **الدور:** معالجة تفاعلات المستخدم وتحديث الحالة
- **تفصيل:**
  - 109: إخطار بتغيير المحتوى
  - 112-118: تحديث الإحصائيات
  - 122-123: تحديث التنسيق الحالي

#### 7. `handlePaste(e: React.ClipboardEvent<HTMLDivElement>)`
- **السطر:** 126-132
- **الدور:** معالجة لصق النصوص مع الحفاظ على التنسيق
- **تفصيل:**
  - 128: التحقق من وجود مرجع صالح
  - 129: استدعاء دالة اللصق المحسنة مع معالجة التنسيقات

#### 8. `handleKeyDown(e: React.KeyboardEvent<HTMLDivElement>)`
- **السطر:** 134-184
- **الدور:** معالجة ضغطات لوحة المفاتيح
- **تفصيل:**
  - 135-163: معالجة مفتاح Enter (إنشاء سطر جديد بالتنسيق المناسب)
  - 165-174: معالجة مفتاح Tab (تغيير التنسيق)
  - 176-183: معالجة الاختصارات (Ctrl+1 إلى Ctrl+6)

#### 9. `getNextFormatOnEnter(currentFormat: string): string`
- **السطر:** 229-243
- **الدور:** تحديد التنسيق التالي عند الضغط على Enter
- **تفصيل:**
  - 230-241: تعريف جدول الانتقالات بين التنسيقات
  - 242: إرجاع action كتنسيق افتراضي

---

## 2. EditorFooter.tsx
**المسار:** [src/components/editor/EditorFooter.tsx](src/components/editor/EditorFooter.tsx)

**الدور:** شريط سفلي يعرض إحصائيات المستند والتنسيق الحالي.

### الواجهة (Interface)
```typescript
interface EditorFooterProps {
    stats: DocumentStats;           // إحصائيات المستند
    currentFormatLabel: string;     // اسم التنسيق الحالي
}
```

### المكون (Component)
- **السطر:** 10-26
- **الدور:** عرض الشريط السفلي
- **تفصيل:**
  - 12: تعريف الشريط بحد علوي وخلفية卡片
  - 13: حاوية مرنة للتوزيع
  - 14-18: عرض الإحصائيات (صفحات، كلمات، أحرف، مشاهد)
  - 20-22: عرض التنسيق الحالي

---

## 3. EditorHeader.tsx
**المسار:** [src/components/editor/EditorHeader.tsx](src/components/editor/EditorHeader.tsx)

**الدور:** شريط علوي يحتوي على أزرار الإجراءات الرئيسية (حفظ، تحميل، سجل، تراجع/إعادة).

### الواجهة (Interface)
```typescript
type EditorHeaderProps = {
  onSave?: () => void;       // وظيفة الحفظ
  onDownload?: () => void;   // وظيفة التحميل
  onHistory?: () => void;    // وظيفة عرض السجل
  onInfo?: () => void;       // وظيفة عرض المعلومات
  onUndo?: () => void;       // وظيفة التراجع
  onRedo?: () => void;       // وظيفة الإعادة
};
```

### المكون (Component)
- **السطر:** 22-98
- **الدور:** عرض الشريط العلوي
- **تفصيل:**
  - 28: تعريف فئة الأيقونات المشتركة
  - 31: الشريط الرئيسي مع خلفية متدرجة وتأثير blur
  - 32: حاوية الأزرار المرنة
  - 34-42: زر المعلومات (لون سماوي)
  - 45-58: أزرار التراجع/الإعادة (لون رمادي)
  - 62-71: زر الحفظ (لون بنفسجي)
  - 74-82: زر التحميل (لون وردي)
  - 85-93: زر السجل (لون كهرماني)

---

## 4. EditorSidebar.tsx
**المسار:** [src/components/editor/EditorSidebar.tsx](src/components/editor/EditorSidebar.tsx)

**الدور:** شريط جانبي يحتوي على أدوات مساعدة للسيناريو.

### الواجهة (Interface)
```typescript
interface EditorSidebarProps {
    onMessages?: () => void;   // وظيفة فتح الرسائل
    onIdeas?: () => void;      // وظيفة فتح الأفكار
    onCheck?: () => void;      // وظيفة فحص السيناريو
}
```

### المكون (Component)
- **السطر:** 21-90
- **الدور:** عرض الشريط الجانبي
- **تفصيل:**
  - 23: الشريط الجانبي مع خلفية متدرجة
  - 25: حاوية شبكة للأزرار
  - 26-33: زر الرسائل (لون أخضر/emerald)
  - 34-41: زر الأفكار (لون أصفر/yellow)
  - 42-49: زر الفحص (لون أحمر/rose)
  - 51-57: زر الفيلم (لون أزرق/blue)
  - 58-64: زر الكاميرا (لون بنفسجي/violet)
  - 65-71: زر التشغيل (لون أخضر/emerald)
  - 72-78: زر الإيقاف المؤقت (لون كهرماني/amber)
  - 79-85: زر المقص (لون سماوي/cyan)

---

## 5. EditorToolbar.tsx
**المسار:** [src/components/editor/EditorToolbar.tsx](src/components/editor/EditorToolbar.tsx)

**الدور:** شريط الأدوات الذي يعرض أوامر التنسيق النصية وأدوات إضافية.

### الواجهة (Interface)
```typescript
interface EditorToolbarProps {
    onFormatCommand: (command: string, value?: string) => void;  // وظيفة تنفيذ أوامر التنسيق
}
```

### المكون (Component)
- **السطر:** 15-115
- **الدور:** عرض شريط الأدوات
- **تفصيل:**
  - 17: الشريط الثابت في الأعلى مع تأثير blur
  - 19: حاوية الأدوات
  - 21-28: زر المعلومات (تلميح)
  - 30-37: زر التراجع (تلميح)
  - 39: فاصل عمودي
  - 41-52: زر العريض (لون أزرق)
  - 53-64: زر المائل (لون بنفسجي)
  - 65-76: زر محاذاة يمين (لون وردي)
  - 77-88: زر التوسيط (لون سماوي)
  - 90: فاصل عمودي
  - 92-109: أزرار إضافية (فيلم، كاميرا، إيقاف، مقص، رفع، ملف)

---

## 6. ScreenplayEditor.tsx
**المسار:** [src/components/editor/ScreenplayEditor.tsx](src/components/editor/ScreenplayEditor.tsx)

**الدور:** المكون الرئيسي الذي يجمع جميع مكونات المحرر ويدير الحالة العامة.

### الحالة (State)
```typescript
const [content, setContent] = useState('');                    // محتوى المستند
const [currentFormat, setCurrentFormat] = useState('action');  // التنسيق الحالي
const [selectedFont, setSelectedFont] = useState('Amiri');      // الخط المختار
const [selectedSize, setSelectedSize] = useState('14pt');       // الحجم المختار
const [documentStats, setDocumentStats] = useState<DocumentStats>({...});  // إحصائيات المستند
const [isProcessingAI, setIsProcessingAI] = useState(false);    // حالة معالجة الذكاء الاصطناعي
```

### الدوال (Functions)

#### 1. `handleSave()`
- **السطر:** 29-34
- **الدور:** حفظ المستند وإظهار إشعار

#### 2. `handleDownload()`
- **السطر:** 36-41
- **الدور:** تحميل المستند وإظهار إشعار

#### 3. `handleHistory()`
- **السطر:** 43-48
- **الدور:** عرض سجل التغييرات

#### 4. `handleMessages()`
- **السطر:** 50-55
- **الدور:** فتح نافذة الرسائل

#### 5. `handleInfo()`
- **السطر:** 57-62
- **الدور:** عرض معلومات المستند

#### 6. `handleLightbulb()`
- **السطر:** 64-69
- **الدور:** عرض الأفكار والاقتراحات

#### 7. `handleStethoscope()`
- **السطر:** 71-76
- **الدور:** فحص جودة السيناريو

#### 8. `handleContentChange()`
- **السطر:** 78-82
- **الدور:** تحديث محتوى المستند عند التغيير
- **تفصيل:**
  - 79: التحقق من وجود مرجع للمحرر
  - 80: حفظ HTML المحتوى

#### 9. `handleStatsChange(stats: DocumentStats)`
- **السطر:** 84-86
- **الدور:** تحديث إحصائيات المستند

#### 10. `handleFormatChange(format: string)`
- **السطر:** 88-90
- **الدور:** تحديث التنسيق الحالي

#### 11. `useEffect` - التهيئة الأولية
- **السطر:** 92-100
- **الدور:** إنشاء عنصر div أولي عند تحميل المحرر
- **تفصيل:**
  - 93: التحقق من أن المحرر فارغ
  - 94-96: إنشاء div جديد بتنسيق action
  - 97: إضافته إلى المحرر
  - 98: تحديث المحتوى

#### 12. `handleFormatCommand(command: string, value?: string)`
- **السطر:** 102-106
- **الدور:** تنفيذ أوامر التنسيق (عريض، مائل، محاذاة، إلخ)

#### 13. `handleGenerateIdeas(theme: string)`
- **السطر:** 108-124
- **الدور:** توليد أفكار للمشاهد باستخدام الذكاء الاصطناعي
- **تفصيل:**
  - 109: تعيين حالة المعالجة
  - 111: استدعاء دالة توليد الأفكار
  - 112: تحويل الأفكار إلى HTML
  - 113: إدراج الأفكار في المحرر
  - 114-120: معالجة الأخطاء

#### 14. `handleAutoFormat()`
- **السطر:** 126-175
- **الدور:** تنسيق تلقائي للنص باستخدام الذكاء الاصطناعي
- **تفصيل:**
  - 127-135: التحقق من وجود نص للتنسيق
  - 137: تعيين حالة المعالجة
  - 139: استدعاء دالة التنسيق التلقائي
  - 141-156: تحويل النص المنسق إلى HTML
  - 158: تحديث المحرر بالنص الجديد
  - 161-164: إظهار إشعار النجاح
  - 165-171: معالجة الأخطاء

### واجهة المستخدم (UI)
- **السطر:** 177-229
- **تفصيل:**
  - 179-184: الحاوية الرئيسية مع دعم الوضع الليلي/النهاري
  - 185-190: الشريط العلوي
  - 191-217: المنطقة الرئيسية مع التدرج اللوني والإضاءة الخلفية
  - 202-214: منطقة الكتابة
  - 219-224: الشريط الجانبي
  - 226: الشريط السفلي

---

## 7. index.ts
**المسار:** [src/components/editor/index.ts](src/components/editor/index.ts)

**الدور:** ملف تصدير جميع مكونات المحرر للاستيراد المcentralized.

### التصديرات
```typescript
export { ScreenplayEditor } from './ScreenplayEditor';
export { EditorHeader } from './EditorHeader';
export { EditorToolbar } from './EditorToolbar';
export { EditorArea } from './EditorArea';
export { EditorFooter } from './EditorFooter';
export { EditorSidebar } from './EditorSidebar';
```

---

## ملاحظات مهمة

### اختصارات لوحة المفاتيح
- **Enter:** إنشاء سطر جديد بالتنسيق المناسب
- **Tab:** التنقل بين التنسيقات
- **Shift+Tab:** الرجوع للخلف في التنسيقات
- **Ctrl+1:** رأس مشهد (Scene Header)
- **Ctrl+2:** شخصية (Character)
- **Ctrl+3:** حوار (Dialogue)
- **Ctrl+4:** إجراء (Action)
- **Ctrl+6:** انتقال (Transition)

### تسلسل التنسيقات الافتراضي
1. رأس المشهد (scene-header-1)
2. الإجراء (action)
3. الشخصية (character)
4. الانتقال (transition)

### تنسيقات السيناريو المدعومة
- **basmala:** البسملة
- **scene-header-top-line:** السطر العلوي للمشهد
- **scene-header-1:** رأس المشهد الرئيسي
- **scene-header-2:** رأس المشهد الثانوي
- **scene-header-3:** رأس المشهد الثالث
- **action:** وصف الإجراءات
- **character:** اسم الشخصية
- **dialogue:** الحوار
- **parenthetical:** التعليق بين قوسين
- **transition:** الانتقال بين المشاهد

---

## التبعيات الخارجية

### React & Next.js
- `react`: المكتبة الأساسية
- `next-themes`: دعم الوضع الليلي/النهاري

### Lucide Icons
- جميع الأيقونات المستخدمة في الواجهة

### الملفات الداخلية
- `@/constants`: الثوابت والتنسيقات
- `@/utils`: الدوال المساعدة
- `@/types/screenplay`: أنواع TypeScript
- `@/ai/flows`: دوال الذكاء الاصطناعي
- `@/hooks/use-toast`: إشعارات التوست

---

## الخلاصة
هذه المكونات تعمل معاً لإنشاء محرر سيناريو احترافي يدعم:
- التنسيق التلقائي للسيناريوهات
- الاختصارات السريعة
- إحصائيات المستند
- الوضع الليلي/النهاري
- الذكاء الاصطناعي لتوليد الأفكار والتنسيق
- واجهة مستخدم عصرية مع تأثيرات بصرية جميلة
